<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Virtual Keyboard - Leap</title>

    <script src="http://js.leapmotion.com/0.2.0/leap.min.js"></script>

    <script src="http://code.jquery.com/jquery-latest.min.js"
        type="text/javascript"></script>

     <script>

    // Store frame for motion functions
    var previousFrame = null;
    var paused = false;
    var pauseOnGesture = false;

    // Setup Leap loop with frame callback function
    var controllerOptions = {enableGestures: true};

    Leap.loop(controllerOptions, function(frame) {
      if (paused) {
        return; // Skip this update
      }

      // Display Frame object data
      var frameOutput = document.getElementById("frameData");

      var frameString = "Frame ID: " + frame.id  + "<br />"
                      + "Timestamp: " + frame.timestamp + " &micro;s<br />"
                      + "Hands: " + frame.hands.length + "<br />"
                      + "Fingers: " + frame.fingers.length + "<br />"
                      + "Tools: " + frame.tools.length + "<br />"
                      + "Gestures: " + frame.gestures.length + "<br />";

      // Frame motion factors
      if (previousFrame && previousFrame.valid) {
        var translation = frame.translation(previousFrame);

        var rotationAxis = frame.rotationAxis(previousFrame);
        var rotationAngle = frame.rotationAngle(previousFrame);

        var scaleFactor = frame.scaleFactor(previousFrame);
      }     

      // Display Pointable (finger and tool) object data
      var pointableOutput = document.getElementById("pointableData");
      var pointableString = "";
      if (frame.pointables.length > 0) {
        for (var i = 0; i < frame.pointables.length; i++) {
          var pointable = frame.pointables[i];

          pointableString += "<div style='width:250px; float:left; padding:5px'>";
          pointableString += "Pointable ID: " + pointable.id + "<br />";
          pointableString += "Belongs to hand with ID: " + pointable.handId + "<br />";

          if (pointable.tool) {
            pointableString += "Classified as a tool <br />";
            pointableString += "Length: " + pointable.length.toFixed(1) + " mm<br />";
            pointableString += "Width: "  + pointable.width.toFixed(1) + " mm<br />";
          }
          else {
            pointableString += "Classified as a finger<br />";
            pointableString += "Length: " + pointable.length.toFixed(1) + " mm<br />";
          }

          pointableString += "Direction: " + vectorToString(pointable.direction, 2) + "<br />";
          pointableString += "Tip position: " + vectorToString(pointable.tipPosition) + " mm<br />";
          pointableString += "Tip velocity: " + vectorToString(pointable.tipVelocity) + " mm/s<br />";

          pointableString += "</div>";
        }

        var pointable = frame.pointables[0];
        var fingerObj = document.getElementById("fingertip");


        //set the size of the finger pointing object based on the z-height from the Leap
        var zValue = frame.pointables[0].tipPosition[1].toFixed(0);
        fingerObj.style.width= ""+zValue/3+"px";
        fingerObj.style.height= ""+zValue/3+"px";

        //set the position of the finger object on the screen based on x/y values from the leap
        var w=window.innerWidth;
		    var h=window.innerHeight;
        //position starts in the middle of the window, moves up and down based on Leap data, and is centered based on size
        yperc = frame.pointables[0].tipPosition[2] / 200;
        xperc = frame.pointables[0].tipPosition[0] / 200;
        var topPosition = (h /2) + ( (h/2) * yperc) - (zValue/2);
        var leftPosition = (w /2) + ( (w/2) * xperc) - (zValue/2);

        //output data based on finger position
        var positionString = "innerWidth: "+w+" innerHeight: "+h+"<br />";
        positionString += "w/2: "+(w/2)+" h/2: "+(h/2)+"<br />";
        positionString += "topPos: "+topPosition.toFixed(0)+" leftPos: "+leftPosition.toFixed(0)+"<br />";
        positionString += "xMov: "+frame.pointables[0].tipPosition[2] + " yMov: "+frame.pointables[0].tipPosition[0]+"<br />";
        document.getElementById("positionInfo").innerHTML = positionString;

        //set the position of the html object
        fingerObj.style.top = ""+topPosition.toFixed(0)+"px";
        fingerObj.style.left = ""+leftPosition.toFixed(0)+"px";


        var keyObj = document.getElementById("a");

        var keyPost = findPos(keyObj);

        var targetElement = document.elementFromPoint(leftPosition, topPosition);

        var collString = "targetClassName = "+targetElement.className + "";
        

        if( targetElement.className.indexOf("key") != -1){
          collString += "<br /> it is a key";
          setHover(targetElement, true);
        }else{
          clearHovers();
        }

        document.getElementById("collisionInfo").innerHTML = collString;

      }
      else {
        pointableString += "<div>No pointables</div>";
      }
      pointableOutput.innerHTML = pointableString;

      // Store frame for motion functions
      previousFrame = frame;
    })

    function vectorToString(vector, digits) {
      if (typeof digits === "undefined") {
        digits = 1;
      }
      return "(" + vector[0].toFixed(digits) + ", "
                 + vector[1].toFixed(digits) + ", "
                 + vector[2].toFixed(digits) + ")";
    }

    function setHover(obj, flag){
      if(flag){//flag == true :: turn on hover mode
          //obj.style.className = "key blueBorderHover";
          $(obj).removeClass("blueBorder").addClass("blueBorderHover");
      }else{//flag == false :: turn off hover
          $(obj).removeClass("blueBorderHover").addClass("blueBorder");
      }
    }

    function clearHovers(){
      $('.key').removeClass("blueBorderHover").addClass("blueBorder");
    }

    function findPos(obj) {

      var curleft = curtop = 0;
      if (obj.offsetParent) {
        curleft = obj.offsetLeft
        curtop = obj.offsetTop
        while (obj = obj.offsetParent) {
          curleft += obj.offsetLeft
          curtop += obj.offsetTop
        }
      }
      return [curleft,curtop];
    }

    </script>


    <!-----------------------------STYLES------------------>
    <style>
      .key{
        height: 200px;
        width: 200px;

        z-index: 100;

        text-align:center;
        line-height:200px;
        color:#9ecaed;
        font-size:36px;
        font-family: verdana;

        position: fixed;
        top: 200px;
        left: 200px;
        
          
        outline: none;
         
      }
        .blueBorder{
          border: 1px solid #9ecaed;
          box-shadow: 0 0 3px #9ecaed;
        }
        .blueBorderHover{
          border: 1px solid #9ecaed;
          box-shadow: 0 0 25px #9ecaed;
        }

		.fingertip{
			height: 20px;
			width: 20px;

      z-index: 50;
			position: fixed;
			top:0px;
			left:0px;

			border: 1px solid #BF0000;
    			border-radius:3px;
			outline: none;
    			box-shadow: 0 0 3px #BF0000;
		}
    #pointableData{
      color:#dddddd;
    }
    #positionInfo{
      position:fixed;
      top:0px;
      left:800px;
    }
    #collisionInfo{
      position:fixed;
      top:100px;
      left:800px;
    }
    </style>
</head>
<body>

	<div class="key blueBorder" id="a">
		A
	</div>

	<div id="fingertip" class="fingertip"></div>

      <div id="pointableData"></div>
      <div style="clear:both;"></div>

  <div id="positionInfo"></div>

  <div id="collisionInfo"></div>


</body>
</html>
